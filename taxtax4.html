<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax Calculator</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <div class="header-container">
            <div class="header-left">
                <h1>Tax Calculator</h1>
            </div>
            <div class="header-right">
                <div class="currency-selector">
                    <div class="segmented-control currency-control">
                        <button type="button" value="EUR" class="active">‚Ç¨ EUR</button>
                        <!--<button type="button" value="GBP">¬£ GBP</button>-->
                        <!--<button type="button" value="USD">$ USD</button>-->
                    </div>
                </div>
                <button id="fill-test-data" class="test-data-button">üêõ Fill Test Data</button>
                <button id="reset-data" class="test-data-button">üîÑ Reset Data</button>
            </div>
        </div>

        <div class="card">
            <div class="header-with-selector">
                <h2>I want plan my taxes in:</h2>
                <div id="country-selects" class="country-selector"></div>
            </div>
        </div>

        <div class="card">
            
            <div id="income-types"></div>
            
            <h2>Tax Benefits</h2>
            <div id="tax-benefits-container"></div>
            
            <h2>Questions</h2>
            <div id="questions-container"></div>
        
            <button id="calculate-button" class="primary">Calculate Taxes</button>
        </div>

        <div class="card">
            <div class="results-header">
                <h2>Results</h2>
                <div class="view-toggle">
                    <label class="switch">
                        <input type="checkbox" id="view-mode-toggle" checked>
                        <span class="slider round"></span>
                    </label>
                    <span id="view-mode-label">Detailed View</span>
                </div>
            </div>
            <table id="results-table">
                <thead>
                    <tr>
                        <th>Metric</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module" id="js-placeholder">
// Import tax data from separate files
import { taxData } from './js/countries/index.js';
import { resetData, fillTestData } from './js/utils.js';

// --- 1. Data and Constants ---
const incomeTypes = {
    employment: { label: 'Employment Income' },
    soleProprietorship: { label: 'Self-employed' },
    rental: { label: 'Rental Income' },
    investment: { label: 'Investment Income' },
    pension: { label: 'Pension Income' }
};

// ... (rest of the code remains unchanged) ...



function updateQuestions() {
    questionsContainer.innerHTML = ''; // Clear previous questions

    selectedCountries.forEach(countryCode => {
        const countryQuestionIds = countryQuestions[countryCode];
        if (countryQuestionIds) { // Check if questions are defined for the country
            countryQuestionIds.forEach(questionId => {
                const question = questions[questionId];
                if (question) {
                    const questionDiv = document.createElement('div');
                    questionDiv.classList.add('question');

                    const label = document.createElement('label');
                    label.textContent = question.label;
                    label.setAttribute('for', countryCode + '-' + question.id); // Set 'for' attribute
                    questionDiv.appendChild(label);

                    if (question.type === 'select') {
                        const select = document.createElement('select');
                        select.id = countryCode + '-' + question.id; // Unique ID
                        question.options.forEach(option => {
                            const optionElement = document.createElement('option');
                            optionElement.value = option.value;
                            optionElement.textContent = option.text;
                            select.appendChild(optionElement);
                        });
                        questionDiv.appendChild(select);
                    } else if (question.type === 'number') {
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.id = countryCode + '-' + question.id; // Unique ID
                        input.min = "0";
                        questionDiv.appendChild(input);
                    } else if (question.type === 'checkbox') {
                        const input = document.createElement('input');
                        input.type = 'checkbox';
                        input.id = countryCode + '-' + question.id; // Unique ID
                        questionDiv.appendChild(input);
                    } else if (question.type === 'radio') {
                        const radioGroupDiv = document.createElement('div'); // Group for radio buttons
                         radioGroupDiv.id = countryCode + '-' + question.id;
                         question.options.forEach(option => {
                            const optionDiv = document.createElement('div'); // For label and input
                            const input = document.createElement('input');
                            input.type = 'radio';
                            input.name = countryCode + '-' + question.id; //MUST be the same name for mutual exclusivity within the group
                            input.id = countryCode + '-' + question.id + '-' + option.value; //unique id
                            input.value = option.value;


                            const label = document.createElement('label');
                            label.textContent = option.text;
                            label.setAttribute('for', countryCode + '-' + question.id + '-' + option.value); // Connect label to input

                            optionDiv.appendChild(input);
                            optionDiv.appendChild(label);
                            radioGroupDiv.appendChild(optionDiv);
                        });
                       questionDiv.appendChild(radioGroupDiv);
                    }
                    // Add other input types as needed (e.g., text, radio)

                    questionsContainer.appendChild(questionDiv);
                }
            });
        }
    });
     // Event listener for radio buttons changes
    const radioButtons = document.querySelectorAll('input[type="radio"]');
        radioButtons.forEach(radioButton => {
          radioButton.addEventListener('change', (event) => {
                let income_prefix = event.target.id.split('-')[0];
              if(income_prefix === 'pt'){
                  updateSoleProprietorshipFields(event.target.value, 'pt');
              }
              else if(income_prefix === 'fr'){
                  updateSoleProprietorshipFields(event.target.value, 'fr');
              }
      });
    });
}
function updateSoleProprietorshipFields(incomeType, countryPrefix) {
    const regimeControl = document.getElementById(`${countryPrefix}-ptSoleProprietorshipRegime`);
    const amountInput = document.getElementById(`${countryPrefix}-amount-soleProprietorship`);
    const yearsInBusinessInput = document.getElementById(`${countryPrefix}-yearsInBusiness`);

    if (regimeControl) {
        regimeControl.style.display = incomeType === 'soleProprietorship' ? 'flex' : 'none';
    }
    if (amountInput) {
        amountInput.style.display = incomeType === 'soleProprietorship' ? 'block' : 'none';
    }
    if (yearsInBusinessInput) {
        yearsInBusinessInput.style.display = incomeType === 'soleProprietorship' ? 'block' : 'none';
    }

    //Hide, if exists
    const labelRegime = document.querySelector(`label[for="${countryPrefix}-ptSoleProprietorshipRegime"]`);
    if(labelRegime){
        labelRegime.style.display = incomeType === 'soleProprietorship' ? 'block' : 'none';
    }

    const labelAmount = document.querySelector(`label[for="${countryPrefix}-amount-soleProprietorship"]`);
    if(labelAmount){
        labelAmount.style.display = incomeType === 'soleProprietorship' ? 'block' : 'none';
    }

    const labelYearsInBusiness = document.querySelector(`label[for="${countryPrefix}-yearsInBusiness"]`);
    if(labelYearsInBusiness){
        labelYearsInBusiness.style.display = incomeType === 'soleProprietorship' ? 'block' : 'none';
    }
}

function validateYearsInBusiness(hasSoleProprietorship, selectedCountries, yearsInBusiness) {
    // First check if sole proprietorship income is selected
    if (!hasSoleProprietorship) {
        return true;
    }
    
    // Check if France or Portugal are selected (countries where years in business matter)
    const relevantCountrySelected = selectedCountries.includes('fr') || selectedCountries.includes('pt');
    
    // If no relevant country selected, no validation needed
    if (!relevantCountrySelected) {
        return true;
    }
    
    // Now we know we need to validate the years
    const errorDiv = document.getElementById('yearsInBusiness-error');
    
    if (yearsInBusiness === undefined || yearsInBusiness === null || yearsInBusiness < 0) {
        if (errorDiv) {
            errorDiv.textContent = 'Please enter a valid number of years in business.';
            errorDiv.style.display = 'block';
        }
        return false;
    }
    
    if (errorDiv) {
        errorDiv.style.display = 'none';
    }
    return true;
}

// --- 3. Event Listeners ---
// Event listeners will be set up in the DOMContentLoaded event handler

// --- 4. UI Update Functions ---

function toggleCountry(countryCode) {
    console.log('Toggling country:', countryCode);
    const index = selectedCountries.indexOf(countryCode);
    const button = document.querySelector(`button[data-country="${countryCode}"]`);
    if (index > -1) {
        selectedCountries.splice(index, 1);
        if (button) { // Check if button exists
            button.classList.remove('active');
        }
        console.log('Removed country:', countryCode);
    } else {
        selectedCountries.push(countryCode);
        if (button) {
            button.classList.add('active');
        }
        console.log('Added country:', countryCode);
    }
    console.log('Selected countries:', selectedCountries);
    renderTaxBenefits(); // Render tax benefits after toggling a country
    renderQuestions();
    renderIncomeTypes();
    
    // Show a message if no countries are selected
    const calculateButton = document.getElementById('calculate-button');
    if (selectedCountries.length === 0) {
        calculateButton.disabled = true;
        calculateButton.style.opacity = '0.5';
    } else {
        calculateButton.disabled = false;
        calculateButton.style.opacity = '1';
    }
}

// Function to render tax benefits section
function renderTaxBenefits() {
    const taxBenefitsContainer = document.getElementById('tax-benefits-container');
    const currentValues = {};

    // Store current values
    taxBenefitsContainer.querySelectorAll('input').forEach(input => {
        currentValues[input.id] = input.type === 'checkbox' ? input.checked : input.value;
    });

    taxBenefitsContainer.innerHTML = '';

    // Define tax benefits for each country
    const taxBenefits = {
        pt: [
            { id: "nhrStatus", label: "NHR Status (20% flat tax rate)", type: "checkbox" },
            { id: "ifici", label: "IFICI Tax Benefit (20% flat tax rate)", type: "checkbox" }
        ],
        es: [
            { id: "beckhamLaw", label: "Beckham's Law (24% flat tax rate up to ‚Ç¨600,000)", type: "checkbox" }
        ],
        fr: [], // France has no specific tax benefits in this implementation
        uk: [
            { id: "blindPersonsAllowance", label: "Blind Person's Allowance (¬£3,070 additional allowance)", type: "checkbox" }
        ],
        cy: [
            { id: "highSkilledResident", label: "High-Skilled Resident (50% tax exemption)", type: "checkbox" }
        ]
    };

    // Create a table for better organization
    const table = document.createElement('table');
    table.className = 'income-types-table';
    
    // Create table header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    const countryHeader = document.createElement('th');
    countryHeader.textContent = 'Country';
    countryHeader.style.width = '120px'; // Fixed width for country column
    
    const benefitHeader = document.createElement('th');
    benefitHeader.textContent = 'Available Benefits';
    benefitHeader.style.width = '200px'; // Fixed width for benefits column
    
    const descriptionHeader = document.createElement('th');
    descriptionHeader.textContent = 'Description';
    
    headerRow.appendChild(countryHeader);
    headerRow.appendChild(benefitHeader);
    headerRow.appendChild(descriptionHeader);
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Create table body
    const tbody = document.createElement('tbody');

    // Only show benefits for selected countries
    selectedCountries.forEach(countryCode => {
        if (taxBenefits[countryCode] && taxBenefits[countryCode].length > 0) {
            taxBenefits[countryCode].forEach(benefit => {
                const row = document.createElement('tr');
                
                // Country cell with flag
                const countryCell = document.createElement('td');
                countryCell.style.verticalAlign = 'top'; // Align to top
                countryCell.style.whiteSpace = 'nowrap'; // Keep flag and name together
                countryCell.innerHTML = `${taxData[countryCode].flag} ${taxData[countryCode].name}`;
                row.appendChild(countryCell);
                
                // Benefit cell with checkbox
                const benefitCell = document.createElement('td');
                benefitCell.style.verticalAlign = 'top'; // Align to top
                
                const checkboxContainer = document.createElement('div');
                checkboxContainer.style.display = 'flex';
                checkboxContainer.style.alignItems = 'flex-start';
                checkboxContainer.style.paddingTop = '2px'; // Slight padding to align with description
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `${countryCode}-${benefit.id}`;
                
                const label = document.createElement('label');
                label.textContent = benefit.label;
                label.setAttribute('for', `${countryCode}-${benefit.id}`);
                label.style.marginBottom = '0';
                label.style.marginLeft = '4px';
                label.style.fontSize = '12px';
                
                checkboxContainer.appendChild(checkbox);
                checkboxContainer.appendChild(label);
                benefitCell.appendChild(checkboxContainer);
                row.appendChild(benefitCell);
                
                // Description cell
                const descriptionCell = document.createElement('td');
                descriptionCell.style.verticalAlign = 'top'; // Align to top
                let description = '';
                
                if (benefit.id === 'nhrStatus') {
                    description = 'Non-Habitual Resident status provides a flat 20% tax rate on Portuguese-sourced income for 10 years.';
                } else if (benefit.id === 'ifici') {
                    description = 'International Fund for Investment in Cinema and Audiovisual provides a 20% flat tax rate for qualifying professionals.';
                } else if (benefit.id === 'beckhamLaw') {
                    description = 'Special tax regime for foreign workers with a flat 24% rate up to ‚Ç¨600,000 (47% above).';
                } else if (benefit.id === 'blindPersonsAllowance') {
                    description = 'Blind Person\'s Allowance provides an additional allowance of ¬£3,070.';
                } else if (benefit.id === 'highSkilledResident') {
                    description = 'High-Skilled Resident (50% tax exemption) provides a 50% tax exemption for high-skilled residents.';
                }
                
                descriptionCell.textContent = description;
                descriptionCell.style.fontSize = '11px';
                descriptionCell.style.color = 'var(--airbnb-gray)';
                descriptionCell.style.lineHeight = '1.4';
                descriptionCell.style.paddingTop = '3px'; // Align with checkbox
                row.appendChild(descriptionCell);
                
                // Restore previous values
                if (currentValues[checkbox.id] !== undefined) {
                    checkbox.checked = currentValues[checkbox.id];
                }
                
                tbody.appendChild(row);
            });
        }
    });
    
    // If no countries with benefits are selected, show a message
    if (tbody.children.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 3;
        cell.textContent = 'No tax benefits available for the selected countries.';
        cell.style.textAlign = 'center';
        cell.style.padding = '10px';
        cell.style.color = 'var(--airbnb-gray)';
        row.appendChild(cell);
        tbody.appendChild(row);
    }
    
    table.appendChild(tbody);
    taxBenefitsContainer.appendChild(table);
}

function renderQuestions() {
    // Use the global questionsContainer variable
    const currentValues = {};

    // Store current values
    questionsContainer.querySelectorAll('input, select, .segmented-control button.active').forEach(input => {
        if (input.classList && input.classList.contains('active')) {
            // For segmented controls, store the value of the active button
            currentValues[input.closest('.segmented-control').id] = input.value;
        } else {
            currentValues[input.id] = input.type === 'checkbox' ? input.checked : input.value;
        }
    });

    questionsContainer.innerHTML = '';

    const addedQuestions = new Set(); // Track added questions to avoid duplicates

    // First, render common questions from the first selected country
    if (selectedCountries.length > 0) {
        const firstCountry = selectedCountries[0];
        if (taxData[firstCountry]) {
            taxData[firstCountry].questions.forEach(question => {
                if (question.common) {
                    renderQuestion(question, null, currentValues, addedQuestions);
                }
            });
        }
    }

    // Then render country-specific questions
    selectedCountries.forEach(countryCode => {
        if (!taxData[countryCode]) return;

        taxData[countryCode].questions.forEach(question => {
            // Skip common questions as they're already rendered
            if (question.common) return;
            
            // Skip tax benefit questions as they're in a separate section
            if (question.id === "nhrStatus" || question.id === "ifici" || question.id === "beckhamLaw" || question.id === "blindPersonsAllowance" || question.id === "highSkilledResident") {
                return;
            }

            // Check dependencies
            let shouldDisplay = true;
            if (question.dependsOn === "incomeTypes") {
                shouldDisplay = selectedCountries.some(code => {
                    return taxData[code].incomeTypes.some(type => type.id === question.dependencyValue);
                });
            }
            if (!shouldDisplay) return;

            renderQuestion(question, countryCode, currentValues, addedQuestions);
        });
    });
}

// Helper function to render a single question
function renderQuestion(question, countryCode, currentValues, addedQuestions) {
    // For common questions, don't use country prefix in ID
    const elementId = question.common ? question.id : `${countryCode}-${question.id}`;
    
    // Skip if already added
    if (addedQuestions.has(elementId)) return;

    const questionDiv = document.createElement('div');
    questionDiv.classList.add('question');

    const label = document.createElement('label');
    label.textContent = question.label + ': ';
    label.setAttribute('for', elementId);
    questionDiv.appendChild(label);

    let inputElement;
    
    // Handle different input types
    if (question.type === 'select') {
        inputElement = document.createElement('select');
        inputElement.id = elementId;
        question.options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.textContent = option;
            inputElement.appendChild(optionElement);
        });
        questionDiv.appendChild(inputElement);
    } else if (question.type === 'segmented') {
        // Create segmented control
        const segmentedControl = document.createElement('div');
        segmentedControl.classList.add('segmented-control');
        segmentedControl.id = elementId;
        
        // Add special class for marital status
        if (question.id === 'maritalStatus') {
            segmentedControl.classList.add('marital-status');
        }
        
        question.options.forEach(option => {
            const button = document.createElement('button');
            button.type = 'button';
            button.value = option.value;
            button.textContent = option.text;
            button.dataset.value = option.value;
            
            // Set active state based on stored value
            if (currentValues[elementId] === option.value) {
                button.classList.add('active');
            }
            
            button.addEventListener('click', () => {
                // Remove active class from all buttons in this control
                segmentedControl.querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('active');
                });
                // Add active class to clicked button
                button.classList.add('active');
            });
            
            segmentedControl.appendChild(button);
        });
        
        // If no button is active, activate the first one
        if (!segmentedControl.querySelector('button.active')) {
            segmentedControl.querySelector('button').classList.add('active');
        }
        
        questionDiv.appendChild(segmentedControl);
    } else if (question.type === 'checkbox') {
        inputElement = document.createElement('input');
        inputElement.type = 'checkbox';
        inputElement.id = elementId;
        questionDiv.appendChild(inputElement);
    } else {
        inputElement = document.createElement('input');
        inputElement.type = question.type;
        inputElement.id = elementId;
        if (question.type === 'number') {
            inputElement.min = "0";
            inputElement.value = "0";
        }
        questionDiv.appendChild(inputElement);
    }

    questionsContainer.appendChild(questionDiv);

    // Restore previous values for non-segmented controls
    if (inputElement && currentValues[elementId] !== undefined) {
        if (inputElement.type === 'checkbox') {
            inputElement.checked = currentValues[elementId];
        } else {
            inputElement.value = currentValues[elementId];
        }
    }

    // Mark the question as added using the full ID
    addedQuestions.add(elementId);
}



// --- Initial Setup ---

function renderIncomeTypes() {
    const incomeTypesDiv = document.getElementById('income-types');
    const currentIncomeValues = {};

    // Store current values
    incomeTypesDiv.querySelectorAll('input[type="checkbox"][id^="income-"]').forEach(checkbox => {
        const incomeType = checkbox.dataset.incomeType;
        const amountInput = document.getElementById(`amount-${incomeType}`);
        if (checkbox && amountInput) {
            currentIncomeValues[checkbox.id] = {
                checked: checkbox.checked,
                amount: amountInput.value
            };
        }
    });

    // Store the current value of the Years in Business field before clearing the container
    const yearsInBusinessValue = document.getElementById('yearsInBusiness')?.value || '';
    const regimeValue = document.getElementById('pt-ptSoleProprietorshipRegime')?.value || 'Simplified Regime';

    incomeTypesDiv.innerHTML = '';
    const addedIncomeTypes = new Set();

    // Create a table for better alignment
    const table = document.createElement('table');
    table.className = 'income-types-table';
    
    // Create table header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    const typeHeader = document.createElement('th');
    typeHeader.textContent = 'My Income Type';
    typeHeader.style.width = '150px';
    
    const amountHeader = document.createElement('th');
    amountHeader.textContent = 'Amount';
    
    const additionalHeader = document.createElement('th');
    additionalHeader.textContent = 'Additional Info';
    
    headerRow.appendChild(typeHeader);
    headerRow.appendChild(amountHeader);
    headerRow.appendChild(additionalHeader);
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Create table body
    const tbody = document.createElement('tbody');

    for (const incomeTypeId in incomeTypes) {
        const incomeType = incomeTypes[incomeTypeId];

        if (!addedIncomeTypes.has(incomeTypeId)) {
            addedIncomeTypes.add(incomeTypeId);

            const row = document.createElement('tr');
            
            // Type cell with checkbox
            const typeCell = document.createElement('td');
            
            const checkboxContainer = document.createElement('div');
            checkboxContainer.style.display = 'flex';
            checkboxContainer.style.alignItems = 'center';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `income-${incomeTypeId}`;
            checkbox.dataset.incomeType = incomeTypeId;
            
            const label = document.createElement('label');
            label.textContent = incomeType.label;
            label.setAttribute('for', `income-${incomeTypeId}`);
            label.style.marginBottom = '0';
            label.style.marginLeft = '4px';
            
            checkboxContainer.appendChild(checkbox);
            checkboxContainer.appendChild(label);
            typeCell.appendChild(checkboxContainer);
            row.appendChild(typeCell);
            
            // Amount cell
            const amountCell = document.createElement('td');
            
            const amountContainer = document.createElement('div');
            amountContainer.style.display = 'flex';
            amountContainer.style.alignItems = 'center';
            amountContainer.style.visibility = 'hidden';
            
            const amountInput = document.createElement('input');
            amountInput.type = 'number';
            amountInput.id = `amount-${incomeTypeId}`;
            amountInput.value = '0';
            amountInput.min = '0';
            amountInput.disabled = true;
            amountInput.style.width = '100px';
            
            amountContainer.appendChild(amountInput);
            amountCell.appendChild(amountContainer);
            row.appendChild(amountCell);
            
            // Additional info cell (for regime and years)
            const additionalCell = document.createElement('td');
            
            const additionalContainer = document.createElement('div');
            additionalContainer.style.display = 'flex';
            additionalContainer.style.alignItems = 'center';
            additionalContainer.style.gap = '8px';
            additionalContainer.style.visibility = 'hidden';
            
            // Add regime selection and years in business for sole proprietorship
            if (incomeTypeId === 'soleProprietorship' && (selectedCountries.includes('pt') || selectedCountries.includes('fr'))) {
                // Create container for regime selection (only for Portugal)
                if (selectedCountries.includes('pt')) {
                    const regimeContainer = document.createElement('div');
                    regimeContainer.style.display = 'flex';
                    regimeContainer.style.alignItems = 'center';
                    regimeContainer.style.marginBottom = '8px';
                    
                    const regimeLabel = document.createElement('label');
                    regimeLabel.textContent = 'Regime:';
                    regimeLabel.style.display = 'inline-block';
                    regimeLabel.style.marginRight = '8px';
                    regimeLabel.style.fontWeight = 'normal';
                    regimeLabel.style.fontSize = '11px';
                    regimeLabel.style.width = 'auto';
                    
                    const regimeControl = document.createElement('div');
                    regimeControl.classList.add('segmented-control');
                    regimeControl.id = 'pt-ptSoleProprietorshipRegime';
                    regimeControl.style.marginBottom = '0';
                    
                    const regimeOptions = [
                        { value: 'Simplified Regime', text: 'Simplified' },
                        { value: 'Organized Accounting', text: 'Organized' }
                    ];
                    
                    regimeOptions.forEach(option => {
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.value = option.value;
                        button.textContent = option.text;
                        button.dataset.value = option.value;
                        
                        if (regimeValue === option.value) {
                            button.classList.add('active');
                        }
                        
                        button.addEventListener('click', () => {
                            regimeControl.querySelectorAll('button').forEach(btn => {
                                btn.classList.remove('active');
                            });
                            button.classList.add('active');
                        });
                        
                        regimeControl.appendChild(button);
                    });
                    
                    if (!regimeControl.querySelector('button.active')) {
                        regimeControl.querySelector('button').classList.add('active');
                    }
                    
                    regimeContainer.appendChild(regimeLabel);
                    regimeContainer.appendChild(regimeControl);
                    additionalContainer.appendChild(regimeContainer);
                }
                
                // Create container for years in business (common for both countries)
                const yearsContainer = document.createElement('div');
                yearsContainer.style.display = 'flex';
                yearsContainer.style.alignItems = 'center';
                
                const yearsLabel = document.createElement('label');
                yearsLabel.textContent = 'Years:';
                yearsLabel.style.display = 'inline-block';
                yearsLabel.style.marginRight = '3px';
                yearsLabel.style.fontWeight = 'normal';
                yearsLabel.style.fontSize = '11px';
                yearsLabel.style.width = 'auto';
                
                const yearsInBusinessInput = document.createElement('input');
                yearsInBusinessInput.type = 'number';
                yearsInBusinessInput.id = 'yearsInBusiness';
                yearsInBusinessInput.min = '0';
                yearsInBusinessInput.placeholder = 'Years';
                yearsInBusinessInput.style.width = '50px';
                yearsInBusinessInput.required = true;
                
                // Restore the previous value of Years in Business
                if (yearsInBusinessValue) {
                    yearsInBusinessInput.value = yearsInBusinessValue;
                }
                
                yearsContainer.appendChild(yearsLabel);
                yearsContainer.appendChild(yearsInBusinessInput);
                additionalContainer.appendChild(yearsContainer);
                
                // Add error div for years in business
                const yearsInBusinessError = document.createElement('div');
                yearsInBusinessError.id = 'yearsInBusiness-error';
                yearsInBusinessError.classList.add('error');
                yearsInBusinessError.style.display = 'none';
                yearsInBusinessError.style.fontSize = '10px';
                yearsContainer.appendChild(yearsInBusinessError);
            }
            
            additionalCell.appendChild(additionalContainer);
            row.appendChild(additionalCell);
            
            // Restore existing values
            if (currentIncomeValues[checkbox.id]) {
                checkbox.checked = currentIncomeValues[checkbox.id].checked;
                amountInput.value = currentIncomeValues[checkbox.id].amount;
                amountInput.disabled = !checkbox.checked;
                
                if (checkbox.checked) {
                    amountContainer.style.visibility = 'visible';
                    additionalContainer.style.visibility = 'visible';
                }
            }
            
            // Add event listener to checkbox
            checkbox.addEventListener('change', (event) => {
                amountInput.disabled = !event.target.checked;
                
                if (event.target.checked) {
                    amountContainer.style.visibility = 'visible';
                    additionalContainer.style.visibility = 'visible';
                } else {
                    amountContainer.style.visibility = 'hidden';
                    additionalContainer.style.visibility = 'hidden';
                    amountInput.value = "0";
                }
            });
            
            tbody.appendChild(row);
        }
    }
    
    table.appendChild(tbody);
    incomeTypesDiv.appendChild(table);
}

// --- 5. Calculation and Result Display ---

// --- Common/Generic Functions ---
function calculateTotalIncome() {
    let total = 0;
    console.log('Calculating total income...');
    // Get all income type checkboxes
    const incomeCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="income-"]');
    console.log('Found checkboxes:', incomeCheckboxes.length);
    
    incomeCheckboxes.forEach(checkbox => {
        console.log('Checking checkbox:', checkbox.id, 'checked:', checkbox.checked);
        if (checkbox.checked) {
            const incomeType = checkbox.dataset.incomeType;
            const amountInput = document.getElementById(`amount-${incomeType}`);
            console.log('Amount input:', amountInput?.value);
            if (amountInput) {
                const amount = parseFloat(amountInput.value) || 0;
                total += amount;
                console.log('Added amount:', amount, 'Total:', total);
            }
        }
    });
    
    console.log('Final total:', total);
    return total;
}

function calculateIncomeTax(taxableBase, brackets) {
    const incomeTaxDetails = [];
    let totalIncomeTax = 0;
    let remainingIncome = taxableBase;

    brackets.forEach((bracket, index) => {
        const nextThreshold = index < brackets.length - 1 ? brackets[index + 1].threshold : Infinity;
        const taxableAtThisRate = Math.min(remainingIncome, nextThreshold - bracket.threshold);
        const taxAtThisRate = taxableAtThisRate * bracket.rate;
        totalIncomeTax += taxAtThisRate;

        if (taxableAtThisRate > 0) {
            incomeTaxDetails.push({
                rate: bracket.rate,
                taxableAmount: taxableAtThisRate.toFixed(2),
                taxAmount: taxAtThisRate.toFixed(2)
            });
        }
        remainingIncome -= taxableAtThisRate;
    });

    return { totalIncomeTax: totalIncomeTax.toFixed(2), incomeTaxDetails };
}

function calculateOtherSocialSecurity(totalIncome) {
     const IAS = 509.26; // 2024 IAS value
     const monthlyCeiling = 12 * IAS;
     const monthlyFloor = IAS;
     let monthlyTaxableBase = totalIncome / 12;
     let socialSecurityNote = "";
     if(monthlyTaxableBase > monthlyCeiling){
        monthlyTaxableBase = monthlyCeiling;
        socialSecurityNote = "Ceiling Reached";
     } else if (monthlyTaxableBase < monthlyFloor){
        monthlyTaxableBase = monthlyFloor;
        socialSecurityNote = "Floor applied";
     }
     let socialSecurity = monthlyTaxableBase * 0.214 * 12; //always use 0.214 - other countries are treated as independent workers
    return { socialSecurity: socialSecurity.toFixed(2), socialSecurityNote };
}

// --- Spain (ES) Functions ---
function calculateIncomeTaxES(taxableBase, beckhamLaw) {
    if (beckhamLaw) {
        // Beckham Law: Flat rate (24% up to 600,000, 47% above)
        let totalIncomeTax = 0;
        const incomeTaxDetails = [];

        if (taxableBase <= 600000) {
            totalIncomeTax = taxableBase * 0.24;
            incomeTaxDetails.push({
                rate: 0.24,
                taxableAmount: taxableBase.toFixed(2),
                taxAmount: totalIncomeTax.toFixed(2)
            });
        } else {
            totalIncomeTax = 600000 * 0.24;
            incomeTaxDetails.push({
                rate: 0.24,
                taxableAmount: 600000,
                taxAmount: totalIncomeTax.toFixed(2)
            });
            totalIncomeTax += (taxableBase - 600000) * 0.47;
            incomeTaxDetails.push({
                rate: 0.47,
                taxableAmount: (taxableBase - 600000).toFixed(2),
                taxAmount: ((taxableBase - 600000) * 0.47).toFixed(2)
            });
        }

        return { totalIncomeTax: totalIncomeTax.toFixed(2), incomeTaxDetails };
    } else {
        // Standard Progressive Tax Calculation for Spain
        const incomeTaxDetails = [];
        let totalIncomeTax = 0;
        let remainingIncome = taxableBase;
        let previousThreshold = 0;

        taxData.es.incomeTaxBrackets.forEach(bracket => { // Use taxData.es.incomeTaxBrackets
            const taxableAtThisRate = Math.max(0, Math.min(remainingIncome, bracket.threshold - previousThreshold));
            const taxAtThisRate = taxableAtThisRate * bracket.rate;
            totalIncomeTax += taxAtThisRate;

            if (taxableAtThisRate > 0) {
                incomeTaxDetails.push({
                    rate: bracket.rate,
                    taxableAmount: taxableAtThisRate.toFixed(2),
                    taxAmount: taxAtThisRate.toFixed(2)
                });
            }
            remainingIncome -= taxableAtThisRate;
            previousThreshold = bracket.threshold;
        });

        return { totalIncomeTax: totalIncomeTax.toFixed(2), incomeTaxDetails };
    }
}

function calculateSocialSecurityES(totalIncome) {
    const monthlyCeiling = 4720.50;  // Monthly ceiling for 2024
    const rate = 0.0635;          // Combined rate (simplified)
    let socialSecurityNote = "";

    let monthlyTaxableBase = totalIncome / 12; // Calculate monthly base

    if (monthlyTaxableBase > monthlyCeiling) {
        monthlyTaxableBase = monthlyCeiling;
        socialSecurityNote = "Ceiling Reached";
    }
    //No floor implementation
    const monthlyContribution = monthlyTaxableBase * rate;
    const annualContribution = monthlyContribution * 12;

    return { socialSecurity: annualContribution.toFixed(2), socialSecurityNote };
}

// --- Portugal (PT) Functions ---
function calculateSocialSecurityPT(ptSoleProprietorshipIncome, totalIncome, regime, yearsInBusiness, hasSoleProprietorship) {
    const IAS = 509.26; // 2024 IAS value
    const monthlyCeiling = 12 * IAS;
    const monthlyFloor = IAS;
    let taxableBaseForSS = 0;
    let socialSecurityNote = "";
    let rate = 0.11; // Default rate for employment income (11% for employee part only)

    // Apply discount for the first three years for sole proprietorship
    let discountFactor = 1;
    if (yearsInBusiness === 1) {
        discountFactor = 0; // 50% reduction in the first year
    } 

    // Check if this is sole proprietorship income
    if (hasSoleProprietorship) {
        rate = 0.214; // Use 21.4% for sole proprietorship as they pay both parts
        if (regime === 'Simplified Regime') {
            taxableBaseForSS = (ptSoleProprietorshipIncome * 0.70 * discountFactor) / 12;
        } else {
            taxableBaseForSS = (ptSoleProprietorshipIncome * discountFactor) / 12;
        }
    } else {
        // For employment income, use the regular base
        taxableBaseForSS = totalIncome / 12;
    }

    // Apply ceiling/floor *monthly*
    if (taxableBaseForSS > monthlyCeiling) {
        taxableBaseForSS = monthlyCeiling;
        socialSecurityNote = "Ceiling Reached";
    } else if (taxableBaseForSS < monthlyFloor) {
        taxableBaseForSS = monthlyFloor;
        socialSecurityNote = "Floor Applied";
    }

    const socialSecurity = taxableBaseForSS * rate * 12;
    return { socialSecurity: socialSecurity.toFixed(2), socialSecurityNote };
}

function calculateTaxableBasePT(ptSoleProprietorshipIncome, totalIncome, regime, yearsInBusiness) {
    let taxableBase = 0;
    let discountFactor = 1;

    // Apply discount for the first three years
    if (yearsInBusiness === 1) {
        discountFactor = 0.5; // 50% reduction in the first year
    } else if (yearsInBusiness === 2) {
        discountFactor = 0.75; // 25% reduction in the second year
    }

    if (regime === 'Simplified Regime') {
        // Simplified Regime: Different percentages for income tax and social security
        taxableBase = ptSoleProprietorshipIncome * 0.75 * discountFactor; // Apply discount
        console.log('Applying 75% for Simplified Regime with discount');
    } else if (regime === 'Organized Accounting') {
        // Organized Accounting: Taxable base is based on accounting (income - expenses).
        taxableBase = ptSoleProprietorshipIncome * discountFactor; // Apply discount
        console.log('Using full income for Organized Accounting with discount');
    }
    // Add other income sources *to the INCOME TAX taxable base*
    taxableBase += (totalIncome - ptSoleProprietorshipIncome);
    console.log('Final Taxable Base:', taxableBase);
    return taxableBase;
}

function calculateIncomeTaxPT(taxableBase, nhr, ifici) {
    if (nhr) {
        // NHR: Flat rate of 20% on Portuguese-sourced income
        const totalIncomeTax = taxableBase * 0.20;
        const incomeTaxDetails = [{
            rate: 0.20,
            taxableAmount: taxableBase.toFixed(2),
            taxAmount: totalIncomeTax.toFixed(2)
        }];
        return { totalIncomeTax: totalIncomeTax.toFixed(2), incomeTaxDetails };
    }
    else if (ifici) {
          // NHR: Flat rate of 20% on Portuguese-sourced income
        const totalIncomeTax = taxableBase * 0.20;
        const incomeTaxDetails = [{
            rate: 0.20,
            taxableAmount: taxableBase.toFixed(2),
            taxAmount: totalIncomeTax.toFixed(2)
        }];
        return { totalIncomeTax: totalIncomeTax.toFixed(2), incomeTaxDetails };
    }
     else {
        // Standard Progressive Tax Calculation for Portugal
        return calculateIncomeTax(taxableBase, taxData.pt.incomeTaxBrackets); // Reuse generic function
    }
}

// --- France (FR) Functions ---
function calculateSocialSecurityFR(totalIncome, yearsInBusiness = 0, hasSoleProprietorship = false) {
    const rates = taxData.fr.socialSecurity;
    let socialSecurityNote = "";
    
    // Constants for 2024
    const PASS = 43992; // Plafond Annuel de la S√©curit√© Sociale 2024
    const CSG_CRDS_BASE = 0.9825; // CSG and CRDS are calculated on 98.25% of income
    
    // Calculate CSG and CRDS (on 98.25% of total income)
    const csgCrdsBase = totalIncome * CSG_CRDS_BASE;
    const csgAmount = csgCrdsBase * rates.csg;
    const crdsAmount = csgCrdsBase * rates.crds;
    
    // Determine the appropriate rate based on income type
    // For employment income, use employee part only (around 8%)
    // For sole proprietorship, use the full rate (22%)
    const effectiveRate = hasSoleProprietorship ? rates.baseRate : 0.08;
    
    // Calculate base social security with PASS ceiling
    let baseAmount;
    if (totalIncome > PASS) {
        baseAmount = PASS * effectiveRate;
        socialSecurityNote = `Base capped at PASS (${PASS}‚Ç¨)`;
    } else {
        baseAmount = totalIncome * effectiveRate;
    }
    
    // Calculate initial social security amount
    let socialSecurity = csgAmount + crdsAmount + baseAmount;
    
    // Add detailed breakdown to note
    socialSecurityNote = `CSG (${(rates.csg * 100).toFixed(1)}%): ${Math.round(csgAmount)}‚Ç¨, ` +
                        `CRDS (${(rates.crds * 100).toFixed(1)}%): ${Math.round(crdsAmount)}‚Ç¨, ` +
                        `Base (${(effectiveRate * 100).toFixed(1)}%): ${Math.round(baseAmount)}‚Ç¨ ` +
                        (totalIncome > PASS ? `(capped at PASS: ${PASS}‚Ç¨)` : "");
    
    // Apply ACRE reduction only for the first year of sole proprietorship
    if (hasSoleProprietorship && yearsInBusiness === 1) {
        const discount = 0.50; // 50% reduction in first year only
        // Apply discount only to base amount, not to CSG/CRDS
        const discountedBase = baseAmount * (1 - discount);
        socialSecurity = csgAmount + crdsAmount + discountedBase;
        socialSecurityNote += ` (ACRE: 50% first year reduction on base contributions)`;
    }
    
    return { socialSecurity: socialSecurity.toFixed(2), socialSecurityNote };
}

// --- UK Functions ---
function calculateSocialSecurityUK(totalIncome) {
    const rates = taxData.uk.socialSecurity;
    let socialSecurityNote = "";
    
    // Calculate National Insurance contributions
    let niContribution = 0;
    
    // No NI on income below primary threshold
    if (totalIncome <= rates.primaryThreshold) {
        socialSecurityNote = "Below primary threshold - no National Insurance due";
    } else {
        // Calculate NI on income between primary threshold and upper earnings limit
        const middleBandIncome = Math.min(totalIncome, rates.upperEarningsLimit) - rates.primaryThreshold;
        if (middleBandIncome > 0) {
            const middleBandNI = middleBandIncome * rates.primaryRate;
            niContribution += middleBandNI;
            socialSecurityNote = `${(rates.primaryRate * 100).toFixed(0)}% on ¬£${rates.primaryThreshold.toLocaleString()} to ¬£${Math.min(totalIncome, rates.upperEarningsLimit).toLocaleString()}: ¬£${Math.round(middleBandNI).toLocaleString()}`;
        }
        
        // Calculate NI on income above upper earnings limit
        if (totalIncome > rates.upperEarningsLimit) {
            const upperBandIncome = totalIncome - rates.upperEarningsLimit;
            const upperBandNI = upperBandIncome * rates.upperRate;
            niContribution += upperBandNI;
            socialSecurityNote += `, ${(rates.upperRate * 100).toFixed(0)}% on income above ¬£${rates.upperEarningsLimit.toLocaleString()}: ¬£${Math.round(upperBandNI).toLocaleString()}`;
        }
    }
    
    return { socialSecurity: niContribution.toFixed(2), socialSecurityNote };
}

// --- Cyprus (CY) Functions ---
function calculateIncomeTaxCY(taxableBase, highSkilledResident) {
    // Cyprus has a progressive tax system
    // For high-skilled residents, 50% of income is exempt from tax
    
    let effectiveTaxableBase = highSkilledResident ? taxableBase * 0.5 : taxableBase;
    
    // Cyprus tax brackets for 2024
    const cyTaxBrackets = [
        { threshold: 0, rate: 0 },         // 0% up to ‚Ç¨19,500
        { threshold: 19500, rate: 0.20 },  // 20% from ‚Ç¨19,501 to ‚Ç¨28,000
        { threshold: 28000, rate: 0.25 },  // 25% from ‚Ç¨28,001 to ‚Ç¨36,300
        { threshold: 36300, rate: 0.30 },  // 30% from ‚Ç¨36,301 to ‚Ç¨60,000
        { threshold: 60000, rate: 0.35 }   // 35% over ‚Ç¨60,000
    ];
    
    // Calculate tax using the generic function
    const { totalIncomeTax, incomeTaxDetails } = calculateIncomeTax(effectiveTaxableBase, cyTaxBrackets);
    
    // Add note about high-skilled resident exemption if applicable
    if (highSkilledResident) {
        incomeTaxDetails.unshift({
            rate: 0,
            taxableAmount: (taxableBase * 0.5).toFixed(2),
            taxAmount: "0.00"
        });
    }
    
    return { totalIncomeTax, incomeTaxDetails };
}

function calculateSocialSecurityCY(totalIncome) {
    // Cyprus social security rates for 2024
    const employeeRate = 0.083; // 8.3% for employee
    const maxContributionBase = 4840 * 12; // Monthly ceiling of ‚Ç¨4,840 (annual: ‚Ç¨58,080)
    
    let taxableBase = totalIncome;
    let socialSecurityNote = "";
    
    // Apply ceiling if income exceeds maximum contribution base
    if (taxableBase > maxContributionBase) {
        taxableBase = maxContributionBase;
        socialSecurityNote = "Ceiling Reached";
    }
    
    // Calculate social security contribution
    const socialSecurity = taxableBase * employeeRate;
    
    return { 
        socialSecurity: socialSecurity.toFixed(2), 
        socialSecurityNote: socialSecurityNote ? socialSecurityNote : `${(employeeRate * 100).toFixed(1)}% of income` 
    };
}

// --- Main Calculation Functions ---
function collectCommonData() {
    const commonData = {};
    
    // Get total income
    commonData.totalIncome = calculateTotalIncome();
    
    // Get common question values from shared fields
    const maritalStatusControl = document.getElementById('maritalStatus');
    commonData.maritalStatus = maritalStatusControl ? 
        maritalStatusControl.querySelector('button.active')?.value : 'Single';
    
    const childrenInput = document.getElementById('children');
    commonData.numChildren = childrenInput ? parseInt(childrenInput.value) || 0 : 0;

    // Access income for sole proprietorship using a consistent ID format
    const checkbox = document.getElementById('income-soleProprietorship');
    commonData.hasSoleProprietorship = checkbox?.checked || false;
    commonData.soleProprietorshipIncome = 0;
    if (commonData.hasSoleProprietorship) {
        const amountInput = document.getElementById('amount-soleProprietorship');
        commonData.soleProprietorshipIncome = parseFloat(amountInput.value) || 0;
    }
    
    // Get years in business if applicable
    commonData.yearsInBusiness = parseInt(document.getElementById('yearsInBusiness')?.value || 0);
    
    // Get tax benefits for each country
    commonData.taxBenefits = {
        pt: {
            nhr: document.getElementById('pt-nhrStatus')?.checked || false,
            ifici: document.getElementById('pt-ifici')?.checked || false
        },
        es: {
            beckhamLaw: document.getElementById('es-beckhamLaw')?.checked || false
        },
        uk: {
            blindPersonsAllowance: document.getElementById('uk-blindPersonsAllowance')?.checked || false
        },
        cy: {
            highSkilledResident: document.getElementById('cy-highSkilledResident')?.checked || false
        }
    };
    
    // Get regime for Portugal
    const ptRegimeControl = document.getElementById('pt-ptSoleProprietorshipRegime');
    commonData.ptRegime = 'Simplified Regime'; // Default
    if (ptRegimeControl) {
        const activeButton = ptRegimeControl.querySelector('button.active');
        if (activeButton) {
            commonData.ptRegime = activeButton.value;
        }
    }
    
    return commonData;
}

function calculateCountrySpecificData(countryCode, commonData) {
    const results = {};
    
    // Set default values
    results.taxableBase = commonData.totalIncome;
    results.taxRegimeNote = "";
    
    // Country-specific calculations for taxable base and tax regime
    if (countryCode === 'pt') {
        // Portuguese calculations
        const regime = commonData.ptRegime;
        
        results.taxableBase = calculateTaxableBasePT(
            commonData.soleProprietorshipIncome, 
            commonData.totalIncome, 
            regime, 
            commonData.yearsInBusiness
        );
        
        results.taxRegimeNote = regime === 'Simplified Regime'
            ? "Simplified Regime (75% Income Tax, 70% Social Security)"
            : "Organized Accounting";
            
        // Calculate Portuguese income tax
        const nhr = commonData.taxBenefits.pt.nhr;
        const ifici = commonData.taxBenefits.pt.ifici;
        const { totalIncomeTax, incomeTaxDetails } = calculateIncomeTaxPT(results.taxableBase, nhr, ifici);
        results.incomeTax = totalIncomeTax;
        results.incomeTaxDetails = incomeTaxDetails;
        
        // Calculate Portuguese social security
        const { socialSecurity, socialSecurityNote } = calculateSocialSecurityPT(
            commonData.soleProprietorshipIncome, 
            commonData.totalIncome, 
            regime, 
            commonData.yearsInBusiness,
            commonData.hasSoleProprietorship
        );
        results.socialSecurity = socialSecurity;
        results.socialSecurityNote = socialSecurityNote;
    } 
    else if (countryCode === 'fr') {
        // Calculate French family quotient
        let familyQuotient = commonData.maritalStatus === 'Married' ? 2 : 1; // Base quotient
        
        // Add quotient for children
        if (commonData.numChildren >= 1) familyQuotient += 0.5; // First child
        if (commonData.numChildren >= 2) familyQuotient += 0.5; // Second child
        if (commonData.numChildren > 2) familyQuotient += (commonData.numChildren - 2); // Third and subsequent children get 1 part each
        
        // Calculate taxable base with family quotient
        results.taxableBase = commonData.totalIncome;
        results.familyQuotient = familyQuotient;
        results.taxRegimeNote = `Family Quotient: ${familyQuotient} parts`;
        
        // Store original taxable base for display
        results.originalTaxableBase = commonData.totalIncome;
        
        // Adjust taxable base by family quotient
        const taxablePerPart = commonData.totalIncome / familyQuotient;
        
        // Calculate tax per part
        const { totalIncomeTax: taxPerPart, incomeTaxDetails } = calculateIncomeTax(taxablePerPart, taxData[countryCode].incomeTaxBrackets);
        
        // Multiply back by number of parts to get final tax
        results.incomeTax = (parseFloat(taxPerPart) * familyQuotient).toFixed(2);
        results.incomeTaxDetails = incomeTaxDetails.map(detail => ({
            ...detail,
            taxableAmount: (parseFloat(detail.taxableAmount) * familyQuotient).toFixed(2),
            taxAmount: (parseFloat(detail.taxAmount) * familyQuotient).toFixed(2)
        }));
        
        if (commonData.yearsInBusiness > 0) {
            results.taxRegimeNote += `, Years in Business: ${commonData.yearsInBusiness}`;
        }
        
        // Calculate French social security
        const { socialSecurity, socialSecurityNote } = calculateSocialSecurityFR(
            commonData.totalIncome, 
            commonData.yearsInBusiness,
            commonData.hasSoleProprietorship
        );
        results.socialSecurity = socialSecurity;
        results.socialSecurityNote = socialSecurityNote;
    } 
    else if (countryCode === 'uk') {
        // UK tax calculations
        let taxableBase = commonData.totalIncome;
        let taxRegimeNote = "";
        
        // Apply Blind Person's Allowance if selected
        const blindPersonsAllowance = commonData.taxBenefits.uk.blindPersonsAllowance;
        if (blindPersonsAllowance) {
            taxableBase -= 3070; // 2024 Blind Person's Allowance
            taxRegimeNote = "Blind Person's Allowance: ¬£3,070";
        }
        
        // Personal Allowance reduction for high earners
        const personalAllowance = 12570; // 2024 Personal Allowance
        let adjustedPersonalAllowance = personalAllowance;
        
        if (commonData.totalIncome > 100000) {
            // Reduce personal allowance by ¬£1 for every ¬£2 over ¬£100,000
            const reduction = Math.min(personalAllowance, Math.floor((commonData.totalIncome - 100000) / 2));
            adjustedPersonalAllowance -= reduction;
            
            if (taxRegimeNote) {
                taxRegimeNote += ", ";
            }
            taxRegimeNote += `Reduced Personal Allowance: ¬£${adjustedPersonalAllowance.toLocaleString()}`;
        }
        
        // Adjust tax brackets to account for the adjusted personal allowance
        const adjustedBrackets = [...taxData[countryCode].incomeTaxBrackets];
        adjustedBrackets[1].threshold = adjustedPersonalAllowance;
        
        results.taxableBase = taxableBase;
        results.taxRegimeNote = taxRegimeNote;
        
        // Calculate income tax using the adjusted brackets
        const { totalIncomeTax, incomeTaxDetails } = calculateIncomeTax(taxableBase, adjustedBrackets);
        results.incomeTax = totalIncomeTax;
        results.incomeTaxDetails = incomeTaxDetails;
        
        // Calculate UK National Insurance
        const { socialSecurity, socialSecurityNote } = calculateSocialSecurityUK(commonData.totalIncome);
        results.socialSecurity = socialSecurity;
        results.socialSecurityNote = socialSecurityNote;
    } 
    else if (countryCode === 'es') {
        // Spanish calculations
        const beckhamLaw = commonData.taxBenefits.es.beckhamLaw;
        
        // Calculate Spanish income tax
        const { totalIncomeTax, incomeTaxDetails } = calculateIncomeTaxES(results.taxableBase, beckhamLaw);
        results.incomeTax = totalIncomeTax;
        results.incomeTaxDetails = incomeTaxDetails;
        
        // Calculate Spanish social security
        const { socialSecurity, socialSecurityNote } = calculateSocialSecurityES(commonData.totalIncome);
        results.socialSecurity = socialSecurity;
        results.socialSecurityNote = socialSecurityNote;
    }
    else if (countryCode === 'cy') {
        // Cyprus calculations
        const highSkilledResident = commonData.taxBenefits.cy.highSkilledResident;
        
        results.taxRegimeNote = highSkilledResident ? "High-Skilled Resident (50% tax exemption)" : "";
        
        results.taxableBase = commonData.totalIncome;
        
        // Calculate Cyprus income tax
        const { totalIncomeTax, incomeTaxDetails } = calculateIncomeTaxCY(results.taxableBase, highSkilledResident);
        results.incomeTax = totalIncomeTax;
        results.incomeTaxDetails = incomeTaxDetails;
        
        // Calculate Cyprus social security
        const { socialSecurity, socialSecurityNote } = calculateSocialSecurityCY(commonData.totalIncome);
        results.socialSecurity = socialSecurity;
        results.socialSecurityNote = socialSecurityNote;
    }
    else {
        // Default tax calculation for any other country
        const { totalIncomeTax, incomeTaxDetails } = calculateIncomeTax(results.taxableBase, taxData[countryCode].incomeTaxBrackets);
        results.incomeTax = totalIncomeTax;
        results.incomeTaxDetails = incomeTaxDetails;
        
        // Default social security calculation
        const { socialSecurity, socialSecurityNote } = calculateOtherSocialSecurity(commonData.totalIncome);
        results.socialSecurity = socialSecurity;
        results.socialSecurityNote = socialSecurityNote;
    }

    // Final calculations
    results.otherTaxes = results.otherTaxes || 0; // Default to 0 if not set
    results.totalDeductions = parseFloat(results.incomeTax) + parseFloat(results.socialSecurity) + parseFloat(results.otherTaxes);
    results.netIncome = commonData.totalIncome - results.totalDeductions;
    results.effectiveTaxRate = ((results.totalDeductions / commonData.totalIncome) * 100).toFixed(2);

    return results;
}

function calculateTaxes() {
    // Collect all data from the DOM in one place
    const commonData = collectCommonData();
    totalIncome = commonData.totalIncome; // Update the global totalIncome variable

    if (totalIncome <= 0) {
        alert("–û—à–∏–±–∫–∞: –£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–∏–ø –¥–æ—Ö–æ–¥–∞ –∏ –≤–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É.");
        return null;
    }

    // Validate years in business
    if (!validateYearsInBusiness(commonData.hasSoleProprietorship, selectedCountries, commonData.yearsInBusiness)) {
        return null;
    }

    const results = {};
    selectedCountries.forEach(countryCode => {
        results[countryCode] = calculateCountrySpecificData(countryCode, commonData);
    });

    return results;
}

// --- Main Calculation Function (Data Only) ---
function updateCountrySelects() {
   // Use the global countrySelectsContainer variable
    countrySelectsContainer.innerHTML = ''; // Clear previous content

    // Render buttons for each country with flags
    const countries = ['fr', 'es', 'pt', 'uk', 'cy'];
    
    countries.forEach(countryCode => {
        const button = document.createElement('button');
        button.dataset.country = countryCode;
        button.onclick = () => toggleCountry(countryCode);
        button.innerHTML = `${taxData[countryCode].flag} ${taxData[countryCode].name}`;
        
        // Add active class if country is selected
        if (selectedCountries.includes(countryCode)) {
            button.classList.add('active');
        }
        
        countrySelectsContainer.appendChild(button);
    });

    renderIncomeTypes();
}

// --- Display Results Function (Presentation Only) ---

function displayResults(results, isDetailedView) {
    resultsTable.innerHTML = '';

    if (!results) {
        return;
    }

    // If isDetailedView is not provided, get it from the DOM
    if (isDetailedView === undefined) {
        isDetailedView = document.getElementById('view-mode-toggle').checked;
    }

    const headerRow = resultsTable.insertRow();
    headerRow.insertCell().textContent = 'Metric';

    selectedCountries.forEach(countryCode => {
        const th = document.createElement('th');
        th.textContent = `${taxData[countryCode].flag} ${taxData[countryCode].name}`;
        th.style.textAlign = 'right';
        headerRow.appendChild(th);
    });

    // Helper function to round to nearest 100
    const roundToNearestHundred = (value) => Math.round(value / 100) * 100;

    // Return the Total Income row (sum of all incomes)
    const totalIncomeRow = resultsTable.insertRow();
    totalIncomeRow.insertCell().textContent = 'Total Income';
    const totalIncome = calculateTotalIncome();
    selectedCountries.forEach(() => { 
        totalIncomeRow.insertCell().textContent = roundToNearestHundred(totalIncome) + " ‚Ç¨"; 
    });

    // Display the taxable base
    const taxableBaseRow = resultsTable.insertRow();
    taxableBaseRow.insertCell().textContent = 'Taxable Base';
    selectedCountries.forEach(countryCode => {
        taxableBaseRow.insertCell().textContent = roundToNearestHundred(results[countryCode].taxableBase) + " ‚Ç¨";
    });

    // Tax regime note and family quotient info - only in detailed view
    if (isDetailedView) {
        const taxRegimeNoteRow = resultsTable.insertRow();
        taxRegimeNoteRow.insertCell().textContent = "Tax Regime Note";
        taxRegimeNoteRow.classList.add('detailed-view-row');
        selectedCountries.forEach(countryCode => {
            const cell = taxRegimeNoteRow.insertCell();
            cell.textContent = results[countryCode].taxRegimeNote || "";
            
            // Add family quotient calculation details for France
            if (countryCode === 'fr' && results[countryCode].familyQuotient) {
                const quotient = results[countryCode].familyQuotient;
                const originalBase = results[countryCode].originalTaxableBase;
                const perPart = originalBase / quotient;
                cell.innerHTML += `<br>Income per part: ${roundToNearestHundred(perPart)} ‚Ç¨`;
            }
        });
    }

    // Income tax details - only in detailed view
    if (isDetailedView) {
        selectedCountries.forEach(countryCode => {
            results[countryCode].incomeTaxDetails.forEach(detail => {
                const detailRow = resultsTable.insertRow();
                detailRow.insertCell().textContent = `Income Tax (${(detail.rate * 100).toFixed(2)}%)`;
                detailRow.classList.add('detailed-view-row');
                selectedCountries.forEach(innerCountryCode => {
                    if (innerCountryCode === countryCode) {
                        detailRow.insertCell().textContent = `${roundToNearestHundred(detail.taxableAmount)} ‚Ç¨ ‚Üí ${roundToNearestHundred(detail.taxAmount)} ‚Ç¨`;
                    } else {
                        detailRow.insertCell().textContent = "";
                    }
                });
            });
        });
    }

    // Total income tax
    const incomeTaxRow = resultsTable.insertRow();
    incomeTaxRow.insertCell().textContent = 'Total Income Tax';
    incomeTaxRow.classList.add('highlight'); // Highlight important row
    selectedCountries.forEach(countryCode => {
        incomeTaxRow.insertCell().textContent = roundToNearestHundred(results[countryCode].incomeTax) + " ‚Ç¨";
    });

    // Social security
    const socialSecurityRow = resultsTable.insertRow();
    socialSecurityRow.insertCell().textContent = 'Social Security';
    selectedCountries.forEach(countryCode => {
        socialSecurityRow.insertCell().textContent = roundToNearestHundred(results[countryCode].socialSecurity) + " ‚Ç¨";
    });

    // Social security note - only in detailed view
    if (isDetailedView) {
        const socialSecurityNoteRow = resultsTable.insertRow();
        socialSecurityNoteRow.insertCell().textContent = 'Social Security Note';
        socialSecurityNoteRow.classList.add('detailed-view-row');
        selectedCountries.forEach(countryCode => {
            socialSecurityNoteRow.insertCell().textContent = results[countryCode].socialSecurityNote;
        });
    }

    // Other taxes
    const otherTaxesRow = resultsTable.insertRow();
    otherTaxesRow.insertCell().textContent = 'Other Taxes';
    selectedCountries.forEach(countryCode => {
        const otherTaxes = results[countryCode].otherTaxes || 0; // Default to 0 if undefined
        otherTaxesRow.insertCell().textContent = roundToNearestHundred(otherTaxes) + " ‚Ç¨";
    });

    // Total deductions
    const totalDeductionsRow = resultsTable.insertRow();
    totalDeductionsRow.insertCell().textContent = 'Total Deductions';
    totalDeductionsRow.classList.add('highlight'); // Highlight important row
    selectedCountries.forEach(countryCode => {
        totalDeductionsRow.insertCell().textContent = roundToNearestHundred(results[countryCode].totalDeductions) + " ‚Ç¨";
    });

    // Net income
    const netIncomeRow = resultsTable.insertRow();
    netIncomeRow.insertCell().textContent = 'Net Income';
    netIncomeRow.classList.add('highlight'); // Highlight important row
    selectedCountries.forEach(countryCode => {
        netIncomeRow.insertCell().textContent = roundToNearestHundred(results[countryCode].netIncome) + " ‚Ç¨";
    });

    // Effective tax rate
    const effectiveTaxRateRow = resultsTable.insertRow();
    effectiveTaxRateRow.insertCell().textContent = 'Effective Tax Rate';
    effectiveTaxRateRow.classList.add('highlight'); // Highlight important row
    selectedCountries.forEach(countryCode => {
        effectiveTaxRateRow.insertCell().textContent = results[countryCode].effectiveTaxRate + " %";
    });
    
    // Scroll to results
    document.querySelector('.card:last-child').scrollIntoView({ behavior: 'smooth' });
}



// --- Event Listener (Modified) ---
// Event listeners will be set up in the DOMContentLoaded event handler

// --- 6. Session Management and Test Data ---

// --- Variables ---
let selectedCountries = [];
let totalIncome = 0;
let selectedCurrency = 'EUR'; // Default currency

// DOM Elements (will be initialized in DOMContentLoaded)
let countrySelectsContainer;
let questionsContainer;
let calculateButton;
let resultsTable;

// --- DOMContentLoaded Event Listener (Wrap Initialization) ---
document.addEventListener('DOMContentLoaded', () => {
    // Get DOM element references
    countrySelectsContainer = document.getElementById('country-selects');
    questionsContainer = document.getElementById('questions-container');
    calculateButton = document.getElementById('calculate-button');
    resultsTable = document.getElementById('results-table');
    
    // Add currency selector event listeners
    const currencyButtons = document.querySelectorAll('.currency-control button');
    currencyButtons.forEach(button => {
        button.addEventListener('click', () => {
            // Remove active class from all currency buttons
            currencyButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            button.classList.add('active');
            // Update selected currency
            selectedCurrency = button.value;
            // Here we'll later add code to update all displayed amounts
        });
    });
    
    // Add event listener for fill test data button
    const fillTestDataButton = document.getElementById('fill-test-data');
    fillTestDataButton.addEventListener('click', () => {
        // Create a context object with all the necessary variables and functions
        const context = {
            selectedCountries,
            totalIncome,
            resultsTable,
            toggleCountry,
            renderIncomeTypes,
            renderQuestions,
            renderTaxBenefits
        };
        fillTestData(context);
    });
    
    // Add event listener for reset data button
    const resetDataButton = document.getElementById('reset-data');
    resetDataButton.addEventListener('click', () => {
        // Create a context object with all the necessary variables and functions
        const context = {
            selectedCountries,
            totalIncome,
            resultsTable,
            toggleCountry,
            renderIncomeTypes,
            renderQuestions,
            renderTaxBenefits
        };
        resetData(context);
    });
    
    updateCountrySelects();  // Initialize country selects
    renderTaxBenefits();    // Initialize tax benefits section
    renderQuestions();      // Initial questions
    renderIncomeTypes();
    
    // Disable calculate button initially since no countries are selected
    if (selectedCountries.length === 0) {
        calculateButton.disabled = true;
        calculateButton.style.opacity = '0.5';
    } else {
        calculateButton.disabled = false;
        calculateButton.style.opacity = '1';
    }

    // Add event listener for view mode toggle
    const viewModeToggle = document.getElementById('view-mode-toggle');
    const viewModeLabel = document.getElementById('view-mode-label');
    
    viewModeToggle.addEventListener('change', function() {
        const isDetailedView = this.checked;
        if (isDetailedView) {
            viewModeLabel.textContent = 'Detailed View';
        } else {
            viewModeLabel.textContent = 'Simple View';
        }
        
        // Recalculate and display results only if there are already calculated results
        const existingResults = resultsTable.querySelector('tbody');
        if (existingResults && existingResults.children.length > 0) {
            const results = calculateTaxes();
            if (results) {
                displayResults(results, isDetailedView);
            }
        }
    });

    // Set up event listeners
    calculateButton.addEventListener('click', () => {
        console.log('Calculate button clicked');
        const commonData = collectCommonData();
        if (validateYearsInBusiness(commonData.hasSoleProprietorship, selectedCountries, commonData.yearsInBusiness)) {
            console.log('Years in business validated');
            const results = calculateTaxes();
            console.log('Calculation results:', results);
            if (results) {
                const isDetailedView = document.getElementById('view-mode-toggle').checked;
                displayResults(results, isDetailedView);
                console.log('Results displayed');
            }
        }
    });
    
    // Parse URL parameters and trigger actions
    function parseURLParams() {
        const urlParams = new URLSearchParams(window.location.search);
        
        // Check for 'fillTestData' parameter
        if (urlParams.has('fillTestData') && urlParams.get('fillTestData') === 'true') {
            console.log('Filling test data from URL parameter');
            // Create context object for fillTestData function
            const context = {
                selectedCountries,
                totalIncome,
                resultsTable,
                toggleCountry,
                renderIncomeTypes,
                renderQuestions,
                renderTaxBenefits
            };
            // Call fillTestData function
            fillTestData(context);
        }
        
        // Check for 'calculate' parameter
        if (urlParams.has('calculate') && urlParams.get('calculate') === 'true') {
            console.log('Calculating taxes from URL parameter');
            // Wait a short time to ensure test data is fully loaded if that parameter was also used
            setTimeout(() => {
                // Trigger click on calculate button
                calculateButton.click();
            }, 500);
        }
        
        // Check for 'view' parameter to set view mode
        if (urlParams.has('view')) {
            const viewMode = urlParams.get('view');
            const viewModeToggle = document.getElementById('view-mode-toggle');
            
            if (viewMode === 'detailed' && !viewModeToggle.checked) {
                viewModeToggle.checked = true;
                viewModeToggle.dispatchEvent(new Event('change'));
            } else if (viewMode === 'simple' && viewModeToggle.checked) {
                viewModeToggle.checked = false;
                viewModeToggle.dispatchEvent(new Event('change'));
            }
        }
    }
    
    // Call the function to parse URL parameters
    parseURLParams();
});
    </script>
</body>
</html>